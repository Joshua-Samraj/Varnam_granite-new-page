<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Write a Review | Varnam Granites</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #1a1a1a; --accent: #c5a059; --white: #ffffff; --light: #f4f4f4; --green: #27ae60; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--light); color: var(--primary); padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        
        .container { background: var(--white); padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 500px; text-align: center; position: relative; }
        
        /* Loading & Error States */
        .state-container { display: none; flex-direction: column; align-items: center; justify-content: center; height: 300px; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Product Preview */
        .product-preview { display: flex; gap: 15px; align-items: center; text-align: left; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .product-preview img { width: 70px; height: 70px; object-fit: cover; border-radius: 6px; border: 1px solid #eee; }
        
        /* Star Rating */
        .star-rating { font-size: 2rem; color: #ddd; cursor: pointer; margin: 15px 0; transition: 0.2s; }
        .star-rating i:hover, .star-rating i.active { color: #ffa41c; }
        
        /* Form Inputs */
        input[type="text"], textarea { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; box-sizing: border-box; font-size: 1rem; }
        input:focus, textarea:focus { border-color: var(--accent); outline: none; }

        /* Image Upload Styles */
        .upload-box { margin-bottom: 20px; text-align: left; }
        .file-label { display: block; padding: 12px; background: #f8f8f8; border: 2px dashed #ccc; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: 0.3s; text-align: center; color: #666; }
        .file-label:hover { background: #e0e0e0; border-color: var(--accent); color: var(--primary); }
        
        /* Preview Grid */
        #previewContainer { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .preview-item { position: relative; width: 70px; height: 70px; }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
        .remove-btn { position: absolute; top: -6px; right: -6px; background: #e74c3c; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* Submit Button */
        .btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.3s; font-size: 1rem; }
        .btn:hover { background: var(--accent); }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        /* Success State */
        .success-icon { font-size: 4rem; color: var(--green); margin-bottom: 20px; }
    </style>
</head>
<body>

    <div class="container">
        
        <div id="loadingState" class="state-container" style="display: flex;">
            <div class="spinner"></div>
            <div>Verifying Link...</div>
        </div>

        <div id="errorState" class="state-container">
            <i class="fas fa-link" style="font-size: 3rem; color: #e74c3c; margin-bottom: 15px;"></i>
            <h3 style="margin:0;">Invalid or Expired Link</h3>
            <p style="color:#666;">This review link has already been used or does not exist.</p>
        </div>

        <div id="formContent" style="display:none;">
            <h2 style="margin-top:0;">Write a Review</h2>
            
            <div class="product-preview">
                <img id="prodImg" src="" alt="Product">
                <div>
                    <div id="prodName" style="font-weight: 600; font-size: 1.1rem;">Product Name</div>
                    <div id="prodCat" style="color: #666; font-size: 0.9rem;">Category</div>
                </div>
            </div>

            <form id="reviewForm">
                <div class="star-rating">
                    <i class="fas fa-star" data-val="1"></i>
                    <i class="fas fa-star" data-val="2"></i>
                    <i class="fas fa-star" data-val="3"></i>
                    <i class="fas fa-star" data-val="4"></i>
                    <i class="fas fa-star" data-val="5"></i>
                </div>
                <input type="hidden" id="ratingVal" value="0">
                
                <input type="text" id="userName" placeholder="Your Name" required>
                <textarea id="userReview" rows="4" placeholder="Share your experience with this product..." required></textarea>
                
                <div class="upload-box">
                    <label for="reviewImgInput" class="file-label">
                        <i class="fas fa-camera"></i> Upload Photos (Max 5)
                    </label>
                    <input type="file" id="reviewImgInput" accept="image/*" multiple style="display:none;">
                    <div id="previewContainer"></div>
                </div>

                <button type="submit" class="btn" id="submitBtn">Submit Review</button>
            </form>
        </div>

        <div id="successMessage" class="state-container">
            <i class="fas fa-check-circle success-icon"></i>
            <h3 style="margin:0;">Thank You!</h3>
            <p style="color:#666;">Your review has been submitted successfully.</p>
            <a href="index.html" style="color:var(--accent); text-decoration:none; font-weight:600;">Back to Website</a>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const API_URL = 'http://localhost:3000/api/products'; 
        const CLOUD_NAME = 'dyhajxcyf'; 
        const UPLOAD_PRESET = 'Varnam_Granites';

        // --- GLOBAL VARS ---
        const urlParams = new URLSearchParams(window.location.search);
        const productId = parseInt(urlParams.get('id'));
        const token = urlParams.get('token');
        let selectedFiles = [];

        // --- INIT: VERIFY & LOAD ---
        document.addEventListener("DOMContentLoaded", () => {
            // Security Check: Must have ID and Token
            if(!productId || !token) {
                showError();
                return;
            }

            fetch(API_URL)
                .then(res => res.json())
                .then(products => {
                    const product = products.find(p => p.id === productId);
                    
                    // Check if product exists AND if token matches (optional client-side check, backend does real check)
                    if(product) {
                        // Check if token exists in the allowed list (Optional Optimization)
                        if (product.reviewTokens && product.reviewTokens.includes(token)) {
                            loadProductUI(product);
                        } else {
                            showError(); // Token not found in array
                        }
                    } else {
                        showError();
                    }
                })
                .catch(err => showError());
        });

        function loadProductUI(product) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('formContent').style.display = 'block';
            
            document.getElementById('prodName').innerText = product.name;
            document.getElementById('prodCat').innerText = product.category;
            const img = (product.images && product.images.length > 0) ? product.images[0] : 'https://via.placeholder.com/100';
            document.getElementById('prodImg').src = img;
        }

        function showError() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'flex';
        }

        // --- STAR RATING ---
        document.querySelectorAll('.star-rating i').forEach(star => {
            star.addEventListener('click', function() {
                const val = this.getAttribute('data-val');
                document.getElementById('ratingVal').value = val;
                document.querySelectorAll('.star-rating i').forEach(s => {
                    s.classList.toggle('active', s.getAttribute('data-val') <= val);
                });
            });
        });

        // --- IMAGE HANDLING ---
        document.getElementById('reviewImgInput').addEventListener('change', function(e) {
            const newFiles = Array.from(e.target.files);
            if (selectedFiles.length + newFiles.length > 5) {
                alert("Max 5 photos allowed."); return;
            }
            newFiles.forEach(file => {
                selectedFiles.push(file);
                renderPreview(file);
            });
            this.value = ''; 
        });

        function renderPreview(file) {
            const container = document.getElementById('previewContainer');
            const reader = new FileReader();
            reader.onload = function(e) {
                const div = document.createElement('div');
                div.className = 'preview-item';
                div.innerHTML = `
                    <img src="${e.target.result}">
                    <button type="button" class="remove-btn">Ã—</button>
                `;
                
                // Remove Logic
                div.querySelector('.remove-btn').onclick = () => {
                    const idx = selectedFiles.indexOf(file);
                    if (idx > -1) selectedFiles.splice(idx, 1);
                    div.remove();
                };

                container.appendChild(div);
            }
            reader.readAsDataURL(file);
        }

        // --- COMPRESSION ---
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const MAX_WIDTH = 1000; 
                const MAX_HEIGHT = 1000;
                const MIME_TYPE = "image/jpeg";
                const QUALITY = 0.7;

                const blobURL = URL.createObjectURL(file);
                const img = new Image();
                img.src = blobURL;
                img.onerror = () => reject("Image load error");
                
                img.onload = () => {
                    URL.revokeObjectURL(img.src);
                    const canvas = document.createElement("canvas");
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) { height = Math.round((height * MAX_WIDTH) / width); width = MAX_WIDTH; }
                    } else {
                        if (height > MAX_HEIGHT) { width = Math.round((width * MAX_HEIGHT) / height); height = MAX_HEIGHT; }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob((blob) => {
                        resolve(new File([blob], file.name, { type: MIME_TYPE, lastModified: Date.now() }));
                    }, MIME_TYPE, QUALITY);
                };
            });
        }

        // --- UPLOAD & SUBMIT ---
        async function uploadFilesBatch(btn) {
            const results = [];
            for (let i = 0; i < selectedFiles.length; i++) {
                btn.innerText = `Uploading ${i+1}/${selectedFiles.length}...`;
                try {
                    const compressed = await compressImage(selectedFiles[i]);
                    const formData = new FormData();
                    formData.append('file', compressed);
                    formData.append('upload_preset', UPLOAD_PRESET);

                    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
                    const data = await res.json();
                    if(data.secure_url) results.push(data.secure_url);
                } catch(e) { console.error(e); }
            }
            return results;
        }

        document.getElementById('reviewForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const rating = document.getElementById('ratingVal').value;
            if(rating == "0") { alert("Please select a star rating."); return; }

            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerText;
            btn.disabled = true;

            try {
                let imageUrls = [];
                if (selectedFiles.length > 0) {
                    imageUrls = await uploadFilesBatch(btn);
                }

                btn.innerText = "Submitting Review...";
                
                const data = {
                    user: document.getElementById('userName').value,
                    rating: rating,
                    text: document.getElementById('userReview').value,
                    images: imageUrls,
                    token: token // Security Token
                };

                const res = await fetch(`${API_URL}/${productId}/reviews`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const responseData = await res.json();

                if(res.ok) {
                    document.getElementById('formContent').style.display = 'none';
                    document.getElementById('successMessage').style.display = 'flex';
                } else {
                    // Handle expired token error specifically
                    if(res.status === 403) {
                        alert("This link has expired or already been used.");
                        showError();
                    } else {
                        alert(responseData.error || "Submission Failed");
                        btn.innerText = originalText;
                        btn.disabled = false;
                    }
                }
            } catch(err) {
                console.error(err);
                alert("Connection Error");
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>