<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details | Varnam Granites</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --primary: #1a1a1a; --accent: #c5a059; --green: #007600; --red: #b12704; }
        body { font-family: 'Poppins', sans-serif; color: #333; margin:0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        img { max-width: 100%; display: block; }
        
        /* --- LOADING SPINNER --- */
        .loading-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 100px 0; text-align: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { font-weight: 500; color: var(--primary); font-size: 1.1rem; }

        /* Layout */
        .product-wrapper { display: grid; grid-template-columns: 1fr 1.2fr; gap: 40px; margin-top:20px; }
        
        /* Gallery & Thumbs */
        .gallery-container { position: sticky; top: 20px; }
        .main-image { position: relative; border: 1px solid #eee; margin-bottom: 10px; background: #f9f9f9; min-height: 400px; display: flex; align-items: center; justify-content: center; }
        .main-image img { width: 100%; display: block; }
        .arrow-btn { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(255, 255, 255, 0.8); border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.3s; display: flex; align-items: center; justify-content: center; z-index: 2; }
        .arrow-btn:hover { background-color: var(--primary); color: #fff; }
        .prev-btn { left: 10px; }
        .next-btn { right: 10px; }
        .thumbnail-row { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .thumb { width: 60px; height: 60px; border: 1px solid #ddd; cursor: pointer; object-fit: cover; opacity: 0.6; transition: 0.3s; }
        .thumb.active { border: 2px solid var(--accent); opacity: 1; }
        
        /* Info */
        h1 { font-size: 1.8rem; margin: 0 0 10px; }
        .price-value { font-size: 1.8rem; font-weight: 600; color: var(--primary); }
        .stock-status { font-weight: 600; color: var(--green); margin: 10px 0; }
        .stock-status.low { color: var(--red); }
        .btn { padding: 12px 30px; border: none; cursor: pointer; font-weight: 600; margin-right: 10px; border-radius: 4px; }
        .btn-primary { background: var(--accent); color: #fff; }
        
        /* --- REVIEWS SECTION --- */
        .reviews-section { margin-top: 50px; padding-top: 20px; border-top: 1px solid #eee; }
        .review-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .review-card { background: #f9f9f9; padding: 15px; margin-bottom: 10px; border-radius: 5px; }
        
        /* Review Form */
        #reviewFormContainer { display: none; background: #fff; padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .form-input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; }
        .star-rating { font-size: 1.5rem; color: #ccc; cursor: pointer; margin-bottom: 10px; display: inline-block; }
        .star-rating i { transition: color 0.2s; }
        .star-rating i.active { color: #ffa41c; }

        /* Recommendations */
        .rec-section { margin-top: 60px; padding-top: 40px; border-top: 1px solid #eee; }
        .rec-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 20px; color: var(--primary); }
        .rec-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .rec-card { border: 1px solid #eee; border-radius: 8px; overflow: hidden; transition: 0.3s; background: #fff; }
        .rec-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .rec-img { height: 200px; width: 100%; object-fit: cover; }
        .rec-info { padding: 15px; text-align: center; }
        .rec-name { font-weight: 600; margin-bottom: 5px; font-size: 1rem; color: var(--primary); }
        .rec-price { color: var(--accent); font-weight: 600; }

        @media(max-width:768px) { .product-wrapper { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="container">
        <p style="margin-top:20px;"><a href="index.html" style="text-decoration:none; color:#666;">&larr; Back to Collection</a></p>

        <div id="loading" class="loading-container">
            <div class="spinner"></div>
            <div class="loading-text">Fetching Product Details...</div>
        </div>

        <div class="product-wrapper" id="content" style="display:none;">
            <div class="gallery-container">
                <div class="main-image">
                    <button class="arrow-btn prev-btn" onclick="changeImage(-1)"><i class="fas fa-chevron-left"></i></button>
                    <img id="mainImg" src="" alt="Product Image" onerror="this.src='https://via.placeholder.com/500?text=Image+Error'">
                    <button class="arrow-btn next-btn" onclick="changeImage(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="thumbnail-row" id="thumbnailContainer"></div>
            </div>

            <div class="product-info">
                <h1 id="productTitle"></h1>
                <p style="color:#666;">Category: <span id="categoryName" style="text-transform:capitalize;"></span></p>
                <div style="margin: 15px 0; padding:15px 0; border-top:1px solid #eee; border-bottom:1px solid #eee;">
                    <span class="price-value" id="productPrice"></span> <span style="font-size:1rem;">/ sq.ft</span>
                </div>
                <p id="stockStatus" class="stock-status"></p>
                <p id="productDesc" style="line-height: 1.6;"></p>
                <ul style="margin: 20px 0; padding-left: 20px; line-height:1.8;">
                    <li><strong>Origin:</strong> <span id="origin"></span></li>
                    <li><strong>Finish:</strong> <span id="finish"></span></li>
                </ul>
                <button class="btn btn-primary">Add to Cart</button>
            </div>
        </div>

        <div class="reviews-section" id="reviewsSection" style="display:none;">
            <div class="review-header">
                <h3>Customer Reviews</h3>
                <button class="btn btn-primary" onclick="toggleReviewForm()" style="padding: 8px 15px; font-size: 0.9rem;">Write a Review</button>
            </div>

            <div id="reviewFormContainer">
                <h4>Write your review</h4>
                <input type="text" id="revName" class="form-input" placeholder="Your Name" required>
                
                <div class="star-rating" id="starRating">
                    <i class="fas fa-star" data-value="1"></i>
                    <i class="fas fa-star" data-value="2"></i>
                    <i class="fas fa-star" data-value="3"></i>
                    <i class="fas fa-star" data-value="4"></i>
                    <i class="fas fa-star" data-value="5"></i>
                </div>
                <input type="hidden" id="revRating" value="5">

                <textarea id="revText" class="form-input" rows="3" placeholder="Share your experience..." required></textarea>
                <button class="btn btn-primary" onclick="submitReview()">Submit Review</button>
                <button class="btn" onclick="toggleReviewForm()" style="background:#ccc; color:black;">Cancel</button>
            </div>

            <div id="reviewsContainer"></div>
        </div>

        <div class="rec-section" id="recSection" style="display:none;">
            <div class="rec-title">You May Also Like</div>
            <div class="rec-grid" id="recContainer"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // Update this URL to match your backend (localhost or vercel)
        const API_URL = 'http://localhost:3000/api/products'; 

        let currentImageIndex = 0;
        let productImages = [];
        let currentProductId = null;

        // --- INITIALIZATION ---
        document.addEventListener("DOMContentLoaded", () => {
            const urlParams = new URLSearchParams(window.location.search);
            currentProductId = parseInt(urlParams.get('id'));

            if(!currentProductId) {
                document.getElementById('loading').innerHTML = "<p>No product selected.</p>";
                return;
            }

            fetch(API_URL)
                .then(res => res.json())
                .then(products => {
                    const product = products.find(p => p.id === currentProductId);
                    if (product) {
                        renderProduct(product);
                        renderRecommendations(products, product);
                    } else {
                        document.getElementById('loading').innerHTML = "<p>Product Not Found.</p>";
                    }
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('loading').innerHTML = "<p style='color:red'>Server Error. Is backend running?</p>";
                });
        });

        // --- RENDER PRODUCT ---
        function renderProduct(product) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'grid';
            document.getElementById('reviewsSection').style.display = 'block';

            // Images
            productImages = (product.images && product.images.length > 0) 
                ? product.images 
                : ['https://via.placeholder.com/500?text=No+Image'];
            currentImageIndex = 0;

            // Text Info
            document.title = product.name + " | Varnam Granites";
            document.getElementById('productTitle').innerText = product.name;
            document.getElementById('categoryName').innerText = product.category;
            document.getElementById('productPrice').innerText = "₹" + product.price.toFixed(2);
            document.getElementById('productDesc').innerText = product.description;
            document.getElementById('origin').innerText = product.origin || "Unknown";
            document.getElementById('finish').innerText = product.finish || "Standard";

            // Stock
            const stockEl = document.getElementById('stockStatus');
            stockEl.innerText = product.stock;
            if (product.stock.toLowerCase().includes('low')) stockEl.classList.add('low');

            updateMainImage();
            renderThumbnails();
            renderReviews(product.reviews);
        }

        // --- REVIEW LOGIC ---
        function toggleReviewForm() {
            const form = document.getElementById('reviewFormContainer');
            form.style.display = (form.style.display === 'none' || form.style.display === '') ? 'block' : 'none';
        }

        // Star Click Handling
        document.querySelectorAll('.star-rating i').forEach(star => {
            star.addEventListener('click', function() {
                const val = this.getAttribute('data-value');
                document.getElementById('revRating').value = val;
                
                // Highlight stars
                document.querySelectorAll('.star-rating i').forEach(s => {
                    if(s.getAttribute('data-value') <= val) s.classList.add('active');
                    else s.classList.remove('active');
                });
            });
        });

        // Submit Review to Backend
        async function submitReview() {
            const name = document.getElementById('revName').value;
            const rating = document.getElementById('revRating').value;
            const text = document.getElementById('revText').value;

            if(!name || !text) { alert("Please fill all fields"); return; }

            const submitBtn = document.querySelector('#reviewFormContainer .btn-primary');
            submitBtn.innerText = "Submitting...";
            submitBtn.disabled = true;

            try {
                const res = await fetch(`${API_URL}/${currentProductId}/reviews`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user: name, rating: rating, text: text })
                });

                const data = await res.json();

                if(data.success) {
                    renderReviews(data.reviews); // Refresh reviews list
                    toggleReviewForm();
                    // Clear Form
                    document.getElementById('revName').value = '';
                    document.getElementById('revText').value = '';
                    alert("Review Added!");
                } else {
                    alert("Error adding review");
                }
            } catch (err) {
                console.error(err);
                alert("Server Error");
            } finally {
                submitBtn.innerText = "Submit Review";
                submitBtn.disabled = false;
            }
        }

        function renderReviews(reviews) {
            const container = document.getElementById('reviewsContainer');
            container.innerHTML = '';
            
            if(reviews && reviews.length > 0) {
                // Show newest first
                reviews.slice().reverse().forEach(rev => {
                    let stars = '';
                    for(let i=0; i<5; i++) {
                        stars += i < rev.rating ? '<i class="fas fa-star" style="color:#ffa41c"></i>' : '<i class="far fa-star" style="color:#ccc"></i>';
                    }
                    container.innerHTML += `
                        <div class="review-card">
                            <div style="display:flex; justify-content:space-between;">
                                <strong>${rev.user}</strong>
                                <small style="color:#888">${new Date(rev.date || Date.now()).toLocaleDateString()}</small>
                            </div>
                            <div style="margin:5px 0;">${stars}</div>
                            <p>${rev.text}</p>
                        </div>
                    `;
                });
            } else {
                container.innerHTML = "<p>No reviews yet. Be the first to review!</p>";
            }
        }

        // --- GALLERY LOGIC ---
        function renderThumbnails() {
            const container = document.getElementById('thumbnailContainer');
            container.innerHTML = '';
            productImages.forEach((img, idx) => {
                const thumb = document.createElement('img');
                thumb.src = img;
                thumb.className = idx === 0 ? 'thumb active' : 'thumb';
                thumb.onclick = () => { currentImageIndex = idx; updateMainImage(); };
                container.appendChild(thumb);
            });
        }

        function changeImage(dir) {
            currentImageIndex += dir;
            if(currentImageIndex >= productImages.length) currentImageIndex = 0;
            else if(currentImageIndex < 0) currentImageIndex = productImages.length - 1;
            updateMainImage();
        }

        function updateMainImage() {
            document.getElementById('mainImg').src = productImages[currentImageIndex];
            document.querySelectorAll('.thumb').forEach((t, i) => {
                if(i === currentImageIndex) t.classList.add('active');
                else t.classList.remove('active');
            });
        }

        // --- RECOMMENDATION LOGIC ---
        function renderRecommendations(all, current) {
            const related = all.filter(p => p.category === current.category && p.id !== current.id).slice(0, 4);
            if(related.length > 0) {
                document.getElementById('recSection').style.display = 'block';
                const container = document.getElementById('recContainer');
                container.innerHTML = related.map(p => `
                    <a href="product.html?id=${p.id}" class="rec-card">
                        <img src="${p.images[0]}" class="rec-img">
                        <div class="rec-info">
                            <div class="rec-name">${p.name}</div>
                            <div class="rec-price">₹${p.price.toFixed(2)}</div>
                        </div>
                    </a>
                `).join('');
            }
        }
    </script>
</body>
</html>