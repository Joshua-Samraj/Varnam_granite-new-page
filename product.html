<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details | Varnam Granites</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --primary: #1a1a1a; --accent: #c5a059; --green: #007600; --red: #b12704; }
        body { font-family: 'Poppins', sans-serif; color: #333; margin:0; }
        a { text-decoration: none; color: inherit; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        img { max-width: 100%; display: block; }
        
        /* LOADING SPINNER */
        .loading-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 100px 0; text-align: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { font-weight: 500; color: var(--primary); font-size: 1.1rem; }

        /* PRODUCT LAYOUT */
        .product-wrapper { display: grid; grid-template-columns: 1fr 1.2fr; gap: 40px; margin-top:20px; }
        
        /* Gallery */
        .gallery-container { position: sticky; top: 20px; }
        .main-image { position: relative; border: 1px solid #eee; margin-bottom: 10px; background: #f9f9f9; min-height: 400px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .main-image img { width: 100%; height: 100%; object-fit: cover; display: block; }
        
        /* Arrows */
        .arrow-btn { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(255, 255, 255, 0.8); border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.3s; display: flex; align-items: center; justify-content: center; z-index: 2; }
        .arrow-btn:hover { background-color: var(--primary); color: #fff; }
        .prev-btn { left: 10px; }
        .next-btn { right: 10px; }

        /* Thumbnails */
        .thumbnail-row { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .thumb { width: 60px; height: 60px; border: 1px solid #ddd; cursor: pointer; object-fit: cover; opacity: 0.6; transition: 0.3s; }
        .thumb:hover { opacity: 1; }
        .thumb.active { border: 2px solid var(--accent); opacity: 1; }
        
        /* Info */
        h1 { font-size: 1.8rem; margin: 0 0 10px; }
        .price-value { font-size: 1.8rem; font-weight: 600; color: var(--primary); }
        .stock-status { font-weight: 600; color: var(--green); margin: 10px 0; }
        .stock-status.low { color: var(--red); }
        .btn { padding: 12px 30px; border: none; cursor: pointer; font-weight: 600; margin-right: 10px; border-radius: 4px; }
        .btn-primary { background: var(--accent); color: #fff; transition: 0.3s; }
        .btn-primary:hover { background: #b08d4c; }
        
        /* Reviews */
        .reviews-section { margin-top: 50px; padding-top: 20px; border-top: 1px solid #eee; }
        .review-card { background: #f9f9f9; padding: 15px; margin-bottom: 10px; border-radius: 5px; }
        
        /* Review Toggle Logic */
        .hidden-review { display: none; }
        .review-card.reveal-anim { display: block; animation: fadeInReview 0.5s ease forwards; }
        @keyframes fadeInReview { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .show-more-btn { 
            display: none; margin: 20px auto; background: transparent; border: 1px solid var(--primary); 
            color: var(--primary); padding: 10px 25px; border-radius: 25px; cursor: pointer; font-weight: 600; transition: 0.3s; 
        }
        .show-more-btn:hover { background: var(--primary); color: #fff; }

        /* Customer Photos */
        #customerPhotosSection { margin-top: 40px; margin-bottom: 20px; display: none; }
        .cp-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .cp-grid { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
        .cp-item { width: 80px; height: 80px; border-radius: 8px; overflow: hidden; cursor: pointer; position: relative; flex-shrink: 0; border: 1px solid #ddd; }
        .cp-item img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .cp-item:hover img { transform: scale(1.1); }
        .cp-count { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem; pointer-events: none; }

        /* Lightbox */
        .lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; animation: fadeIn 0.2s; }
        .lightbox img { max-width: 85%; max-height: 85vh; border-radius: 4px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .lightbox-close { position: absolute; top: 20px; right: 30px; color: white; font-size: 3rem; cursor: pointer; transition: 0.2s; z-index: 2002; }
        .lightbox-close:hover { color: var(--accent); }
        .lb-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.1); color: white; border: none; font-size: 2rem; padding: 15px; cursor: pointer; transition: 0.3s; z-index: 2001; border-radius: 5px; }
        .lb-btn:hover { background: rgba(255,255,255,0.3); }
        .lb-prev { left: 20px; }
        .lb-next { right: 20px; }

        /* Recommendations */
        .rec-section { margin-top: 60px; padding-top: 40px; border-top: 1px solid #eee; }
        .rec-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 20px; color: var(--primary); }
        .rec-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .rec-card { border: 1px solid #eee; border-radius: 8px; overflow: hidden; transition: 0.3s; background: #fff; }
        .rec-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .rec-img { height: 200px; width: 100%; object-fit: cover; }
        .rec-info { padding: 15px; text-align: center; }
        .rec-name { font-weight: 600; margin-bottom: 5px; font-size: 1rem; color: var(--primary); }
        .rec-price { color: var(--accent); font-weight: 600; }

        @media(max-width:768px) { .product-wrapper { grid-template-columns: 1fr; } }
        @keyframes fadeIn { from {opacity:0} to {opacity:1} }
    </style>
</head>
<body>

    <div id="lightbox" class="lightbox">
        <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
        <button class="lb-btn lb-prev" onclick="changeLightboxImage(-1)">&#10094;</button>
        <img id="lightboxImg" src="">
        <button class="lb-btn lb-next" onclick="changeLightboxImage(1)">&#10095;</button>
        <div id="lbCounter" style="position:absolute; bottom:20px; color:white; font-size:0.9rem;"></div>
    </div>

    <div class="container">
        <p style="margin-top:20px;"><a href="index.html" style="text-decoration:none; color:#666;">&larr; Back to Collection</a></p>

        <div id="loading" class="loading-container">
            <div class="spinner"></div>
            <div class="loading-text">Fetching Product Details...</div>
        </div>

        <div class="product-wrapper" id="content" style="display:none;">
            <div class="gallery-container">
                <div class="main-image">
                    <button class="arrow-btn prev-btn" onclick="changeImage(-1)"><i class="fas fa-chevron-left"></i></button>
                    <img id="mainImg" src="" alt="Main Product Image" onerror="this.src='https://via.placeholder.com/500?text=Image+Error'">
                    <button class="arrow-btn next-btn" onclick="changeImage(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="thumbnail-row" id="thumbnailContainer"></div>
            </div>

            <div class="product-info">
                <h1 id="productTitle"></h1>
                <p style="color:#666; font-size:0.9rem;">Category: <span id="categoryName" style="text-transform:capitalize;"></span></p>
                <div style="margin: 15px 0; border-top:1px solid #eee; border-bottom:1px solid #eee; padding:15px 0;">
                    <span class="price-value" id="productPrice"></span> <span style="font-size:1rem;">/ sq.ft</span>
                </div>
                <p id="stockStatus" class="stock-status"></p>
                <p id="productDesc" style="line-height: 1.6;"></p>
                <ul style="margin: 20px 0; padding-left: 20px; line-height:1.8;">
                    <li><strong>Origin:</strong> <span id="origin"></span></li>
                    <li><strong>Finish:</strong> <span id="finish"></span></li>
                </ul>
                <button class="btn btn-primary">Add to Cart</button>
            </div>
        </div>

        <div class="reviews-section" id="reviewsSection" style="display:none;">
            
            <div id="customerPhotosSection">
                <div class="cp-title"><i class="fas fa-camera"></i> Customer Photos</div>
                <div class="cp-grid" id="customerPhotos"></div>
            </div>

            <h3>Customer Reviews</h3>
            <div id="reviewsContainer"></div>
            
            <button id="showMoreBtn" class="show-more-btn" onclick="toggleReviews()">
                Show All Reviews
            </button>
        </div>

        <div class="rec-section" id="recSection" style="display:none;">
            <div class="rec-title">You May Also Like</div>
            <div class="rec-grid" id="recContainer"></div>
        </div>

    </div>

    <script>
        // --- CONFIGURATION ---
        const API_URL = 'http://localhost:3000/api/products';

        let currentImageIndex = 0;
        let productImages = [];
        let allCustomerPhotos = [];
        let lightboxIndex = 0;
        let isReviewsExpanded = false; // State for toggle button

        document.addEventListener("DOMContentLoaded", () => {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = parseInt(urlParams.get('id'));

            if(!productId) {
                document.getElementById('loading').innerHTML = "<p>No product selected.</p>";
                return;
            }

            fetch(API_URL)
                .then(response => {
                    if (!response.ok) throw new Error("Server Offline");
                    return response.json();
                })
                .then(products => {
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        renderProduct(product);
                        renderRecommendations(products, product);
                    } else {
                        document.getElementById('loading').innerHTML = "<p>Product Not Found.<br><a href='index.html'>Go Back</a></p>";
                    }
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('loading').innerHTML = `<div style='color:red; text-align:center;'>Unable to connect to server.</div>`;
                });
        });

        function renderProduct(product) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'grid';
            document.getElementById('reviewsSection').style.display = 'block';

            // 1. Main Product Images
            if (product.images && product.images.length > 0) {
                productImages = product.images;
            } else {
                productImages = ['https://via.placeholder.com/500?text=No+Image+Available'];
            }
            currentImageIndex = 0;

            // 2. Fill Info
            document.title = product.name + " | Varnam Granites";
            document.getElementById('productTitle').innerText = product.name;
            document.getElementById('categoryName').innerText = product.category;
            document.getElementById('productPrice').innerText = "₹" + product.price.toFixed(2);
            document.getElementById('productDesc').innerText = product.description;
            document.getElementById('origin').innerText = product.origin || "Unknown";
            document.getElementById('finish').innerText = product.finish || "Standard";

            const stockEl = document.getElementById('stockStatus');
            stockEl.innerText = product.stock;
            stockEl.className = 'stock-status';
            if (product.stock.toLowerCase().includes('low') || product.stock.toLowerCase().includes('out')) {
                stockEl.classList.add('low');
            }

            updateMainImage();
            renderThumbnails();
            
            // 3. Render Reviews & Customer Photos
            if(product.reviews && product.reviews.length > 0) {
                collectCustomerPhotos(product.reviews);
                renderReviews(product.reviews);
            } else {
                document.getElementById('reviewsContainer').innerHTML = "<p>No reviews yet.</p>";
            }
        }

        // --- CUSTOMER PHOTOS ---
        function collectCustomerPhotos(reviews) {
            allCustomerPhotos = [];
            reviews.forEach(rev => {
                if (rev.images && Array.isArray(rev.images)) {
                    rev.images.forEach(img => { if(img) allCustomerPhotos.push(img); });
                } else if (rev.image) {
                    allCustomerPhotos.push(rev.image);
                }
            });
            renderCustomerPhotoGrid();
        }

        function renderCustomerPhotoGrid() {
            const container = document.getElementById('customerPhotos');
            const section = document.getElementById('customerPhotosSection');

            if (allCustomerPhotos.length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';
            container.innerHTML = '';

            const displayLimit = 5;
            allCustomerPhotos.slice(0, displayLimit).forEach((imgUrl, index) => {
                const div = document.createElement('div');
                div.className = 'cp-item';
                div.onclick = () => openLightbox(index);
                const img = document.createElement('img');
                img.src = imgUrl;
                div.appendChild(img);

                if (index === displayLimit - 1 && allCustomerPhotos.length > displayLimit) {
                    const count = allCustomerPhotos.length - displayLimit + 1;
                    const overlay = document.createElement('div');
                    overlay.className = 'cp-count';
                    overlay.innerText = `+${count}`;
                    div.appendChild(overlay);
                }
                container.appendChild(div);
            });
        }

        // --- LIGHTBOX LOGIC ---
        function openLightbox(index) {
            lightboxIndex = index;
            updateLightboxImage();
            document.getElementById('lightbox').style.display = 'flex';
        }
        function closeLightbox() { document.getElementById('lightbox').style.display = 'none'; }
        function changeLightboxImage(direction) {
            lightboxIndex += direction;
            if (lightboxIndex >= allCustomerPhotos.length) lightboxIndex = 0;
            else if (lightboxIndex < 0) lightboxIndex = allCustomerPhotos.length - 1;
            updateLightboxImage();
        }
        function updateLightboxImage() {
            document.getElementById('lightboxImg').src = allCustomerPhotos[lightboxIndex];
            document.getElementById('lbCounter').innerText = `${lightboxIndex + 1} / ${allCustomerPhotos.length}`;
        }
        document.getElementById('lightbox').onclick = function(e) { if(e.target === document.getElementById('lightbox')) closeLightbox(); }

        // --- REVIEWS LIST WITH TOGGLE ---
        function renderReviews(reviews) {
            const container = document.getElementById('reviewsContainer');
            const showMoreBtn = document.getElementById('showMoreBtn');
            container.innerHTML = '';
            
            const sortedReviews = reviews.slice().reverse();
            
            sortedReviews.forEach((rev, index) => {
                let stars = '';
                for(let i=0; i<5; i++) stars += i < rev.rating ? '<i class="fas fa-star" style="color:#ffa41c"></i>' : '<i class="far fa-star" style="color:#ccc"></i>';
                
                let revImgHTML = '';
                if(rev.images && Array.isArray(rev.images) && rev.images.length > 0) {
                    revImgHTML = '<div style="display:flex; gap:5px; margin-top:10px;">';
                    rev.images.forEach(img => {
                        const globalIndex = allCustomerPhotos.indexOf(img);
                        revImgHTML += `<img src="${img}" style="width:60px; height:60px; object-fit:cover; border-radius:4px; cursor:pointer;" onclick="openLightbox(${globalIndex})">`;
                    });
                    revImgHTML += '</div>';
                } else if (rev.image) {
                    const globalIndex = allCustomerPhotos.indexOf(rev.image);
                    revImgHTML = `<img src="${rev.image}" style="width:60px; height:60px; object-fit:cover; border-radius:4px; margin-top:10px; cursor:pointer;" onclick="openLightbox(${globalIndex})">`;
                }

                const hiddenClass = index >= 3 ? 'hidden-review' : ''; // Initially hide > 3

                container.innerHTML += `
                    <div class="review-card ${hiddenClass}">
                        <div style="display:flex; justify-content:space-between;">
                            <strong>${rev.user || 'Anonymous'}</strong>
                            <small style="color:#888">${new Date(rev.date || Date.now()).toLocaleDateString()}</small>
                        </div>
                        <div style="margin:5px 0;">${stars}</div>
                        <p>${rev.text}</p>
                        ${revImgHTML}
                    </div>
                `;
            });

            // Handle Button Logic
            if (sortedReviews.length > 3) {
                showMoreBtn.style.display = 'block';
                isReviewsExpanded = false;
                showMoreBtn.innerText = `Show All Reviews (${sortedReviews.length})`;
            } else {
                showMoreBtn.style.display = 'none';
            }
        }

        // --- NEW: TOGGLE FUNCTION ---
        function toggleReviews() {
            const hiddenItems = document.querySelectorAll('.review-card');
            const btn = document.getElementById('showMoreBtn');
            
            if (!isReviewsExpanded) {
                // SHOW ALL
                hiddenItems.forEach(item => {
                    item.classList.remove('hidden-review');
                    item.classList.add('reveal-anim');
                });
                btn.innerText = "Show Less";
                isReviewsExpanded = true;
            } else {
                // HIDE EXTRA
                hiddenItems.forEach((item, index) => {
                    if(index >= 3) {
                        item.classList.add('hidden-review');
                        item.classList.remove('reveal-anim');
                    }
                });
                
                // Count total for the button text
                const total = hiddenItems.length;
                btn.innerText = `Show All Reviews (${total})`;
                isReviewsExpanded = false;
                
                // Scroll back to reviews top
                document.getElementById('reviewsContainer').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // --- RECOMMENDATIONS ---
        function renderRecommendations(all, current) {
            const related = all.filter(p => p.category === current.category && p.id !== current.id).slice(0, 4);
            if(related.length > 0) {
                document.getElementById('recSection').style.display = 'block';
                const container = document.getElementById('recContainer');
                container.innerHTML = related.map(p => {
                    const img = (p.images && p.images.length > 0) ? p.images[0] : 'https://via.placeholder.com/200';
                    return `<a href="product.html?id=${p.id}" class="rec-card"><img src="${img}" class="rec-img"><div class="rec-info"><div class="rec-name">${p.name}</div><div class="rec-price">₹${p.price.toFixed(2)}</div></div></a>`;
                }).join('');
            }
        }

        // --- MAIN GALLERY ---
        function renderThumbnails() {
            const container = document.getElementById('thumbnailContainer'); container.innerHTML = '';
            productImages.forEach((imgSrc, index) => {
                const img = document.createElement('img'); img.src = imgSrc; img.className = index === 0 ? 'thumb active' : 'thumb';
                img.onclick = () => { currentImageIndex = index; updateMainImage(); }; container.appendChild(img);
            });
        }
        function changeImage(direction) {
            currentImageIndex += direction; if (currentImageIndex >= productImages.length) currentImageIndex = 0; else if (currentImageIndex < 0) currentImageIndex = productImages.length - 1; updateMainImage();
        }
        function updateMainImage() {
            document.getElementById('mainImg').src = productImages[currentImageIndex];
            document.querySelectorAll('.thumb').forEach((t, i) => { if(i === currentImageIndex) t.classList.add('active'); else t.classList.remove('active'); });
        }
    </script>
</body>
</html>